<!-- jewel_db/templates/item_detail.html -->
{% extends "base.html" %}
{% block title %}{{ item.name }} ‚Äì Jewelry Inventory{% endblock %}

{% block content %}

  <!-- HEADER -->
  <div class="mb-6 flex items-center justify-between">
    <h2 class="text-2xl font-semibold">{{ item.name }}</h2>
    <div class="space-x-2">
      <button id="edit-btn"   class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">Edit</button>
      <button id="save-btn"   class="bg-green-600  hover:bg-green-700  text-white px-3 py-1 rounded text-sm" hidden>Save</button>
      <button id="cancel-btn" class="bg-gray-400  hover:bg-gray-500  text-white px-3 py-1 rounded text-sm" hidden>Cancel</button>
      <button id="item-delete-btn" data-id="{{ item.id }}" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">Delete</button>
      <a href="/items" class="text-gray-600 underline text-sm">Back to list</a>
    </div>
  </div>

  <!-- data root -->
  <div id="item-root" data-item-id="{{ item.id }}"></div>

  <!-- GALLERY -->
  <ul id="gallery" class="grid grid-cols-3 gap-4 mb-8">
    {% for img in images %}
    <li data-id="{{ img.id }}" class="relative cursor-pointer border rounded overflow-hidden">
      <button data-image-id="{{ img.id }}"
              class="image-delete-btn absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white px-1 py-0.5 rounded text-xs z-10"
              title="Delete this image">√ó</button>
      <img src="{{ img.url }}" class="w-full h-48 object-cover" loading="lazy"/>
      {% if img.sort_order == 1 %}
        <span data-badge="thumb" class="absolute top-2 left-2 bg-yellow-400 text-white px-1 rounded text-sm z-10">‚òÖ Thumbnail</span>
      {% endif %}
    </li>
    {% endfor %}
  </ul>

  <!-- LIGHTBOX -->
  <div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <button id="lb-close" class="absolute top-4 right-4 text-white text-3xl">&times;</button>
    <button id="lb-prev"  class="absolute left-4 text-white text-4xl select-none">&#10094;</button>

    <div class="relative">
      <img id="lb-img" src="" class="max-h-[80vh] max-w-[80vw] transition-transform"/>
      <div class="absolute bottom-2 left-1/2 -translate-x-1/2 bg-black bg-opacity-50 rounded p-2 flex space-x-4">
        <button id="lb-zoom-in"  class="text-white text-xl select-none">Ôºãüîç</button>
        <button id="lb-zoom-out" class="text-white text-xl select-none">Ôºçüîç</button>
      </div>
    </div>

    <button id="lb-next"  class="absolute right-4 text-white text-4xl select-none">&#10095;</button>
  </div>

  <!-- IMAGE UPLOAD -->
  <div class="mb-8">
    <label class="block font-medium mb-2">Upload Images</label>
    <div class="flex items-center space-x-2">
      <input id="upload-input" type="file" multiple accept="image/*" class="border rounded p-1"/>
      <button type="button" id="detail-webcam-btn" class="bg-gray-600 text-white px-2 py-1 rounded text-sm">üì∑ Capture</button>
      <input id="url-input" type="url" placeholder="Or enter image URL" class="border rounded p-1 flex-1"/>
      <button id="upload-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">Upload</button>
    </div>
  </div>

  <!-- EDIT FORM -->
  <form id="item-detail-form" class="space-y-3 text-gray-700">
    <input type="hidden" name="id" value="{{ item.id }}"/>
    <!-- Name -->
    <div>
      <label class="block font-medium">Name</label>
      <input type="text"
            name="name"
            value="{{ item.name }}"
            disabled
            class="w-full border rounded p-2"/>
    </div>
    <!-- Category -->
    <div>
      <label class="block font-medium">Category</label>
      <select name="category" id="cat-select" class="w-full border rounded p-2" disabled>
        {% for c in ['ring','bracelet','earring','necklace','brooch','other'] %}
          <option value="{{ c }}" {% if c==item.category %}selected{% endif %}>{{ c.title() }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Material -->
    <div>
      <label class="block font-medium">Material</label>
      <input type="text" name="material" value="{{ item.material or '' }}" disabled class="w-full border rounded p-2"/>
    </div>

    <!-- Gemstone -->
    <div>
      <label class="block font-medium">Gemstone</label>
      <input type="text" name="gemstone" value="{{ item.gemstone or '' }}" disabled class="w-full border rounded p-2"/>
    </div>

    <!-- Weight & Price -->
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block font-medium">Weight (g)</label>
        <input type="number" step="0.01" name="weight" value="{{ '%.2f'|format(item.weight) }}" disabled class="w-full border rounded p-2"/>
      </div>
      <div>
        <label class="block font-medium">Price</label>
        <input type="number" step="0.01" name="price"  value="{{ '%.2f'|format(item.price)  }}" disabled class="w-full border rounded p-2"/>
      </div>
    </div>

    <!-- Tags -->
    <div>
      <label class="block font-medium">Tags</label>

      <!-- editable input (hidden until Edit) -->
      <input id="tags-input" list="tags-dl-detail" data-list-id="tags-dl-detail" type="text"
             class="w-full border rounded p-2" style="display:none;"/>

      <datalist id="tags-dl-detail"></datalist>

      <!-- hidden JSON array -->
      <input type="hidden" name="tags" id="tags-hidden"
             value="{{ item.tags|map(attribute='name')|list|tojson }}"/>

      <!-- read-only pillbox -->
      <div id="tags-pillbox" class="flex flex-wrap gap-1 mt-1">
        {% for t in item.tags %}
          <span class="bg-gray-200 px-2 py-0.5 rounded text-xs">{{ t.name }}</span>
        {% endfor %}
      </div>
    </div>

    <!-- Description -->
    <div>
      <label class="block font-medium">Description</label>
      <textarea name="description" rows="3" disabled class="w-full border rounded p-2">{{ item.description or '' }}</textarea>
    </div>
  </form>

{% endblock %}

{% block scripts %}
<!-- SortableJS (classic build) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<!-- Page logic -->
<script type="module">
import { attachTagInput } from "{{ url_for('static', path='js/tag_select.js') }}";

document.addEventListener("DOMContentLoaded", () => {

  /* ---------- helpers ---------- */
  const itemId  = +document.getElementById("item-root").dataset.itemId;
  const $       = (id) => document.getElementById(id);

  const gallery   = $("gallery");
  const form      = $("item-detail-form");
  const editBtn   = $("edit-btn");
  const saveBtn   = $("save-btn");
  const cancelBtn = $("cancel-btn");
  const delBtn    = $("item-delete-btn");

  const uploadIn  = $("upload-input");
  const urlIn     = $("url-input");
  const uploadBt  = $("upload-btn");

  const tagInput  = $("tags-input");
  const tagHidden = $("tags-hidden");
  const pillbox   = $("tags-pillbox");
  const headerH2  = document.querySelector("h2");

  const safeParse = (v) => { try { return JSON.parse(v || "[]"); } catch { return []; } };

  /* ---------- webcam ---------- */
  if (typeof initWebcamCapture === "function") {
    initWebcamCapture("#detail-webcam-btn", "#upload-input");
  }

  /* ---------- tag picker ---------- */
  attachTagInput(tagInput, tagHidden);
  pillbox.innerHTML = "";
  safeParse(tagHidden.value).forEach(addTagPill);

  function addTagPill(tag) {
    if ([...pillbox.children].some(p => p.dataset.tag === tag)) return;
    const pill = document.createElement("span");
    pill.dataset.tag = tag;
    pill.className = "bg-blue-600 text-white text-xs rounded px-2 py-0.5 cursor-pointer";
    pill.textContent = `${tag} √ó`;
    pill.onclick = () => { pill.remove(); syncHidden(); };
    pillbox.appendChild(pill);
    syncHidden();
  }
  function syncHidden() {
    tagHidden.value = JSON.stringify([...pillbox.children].map(p => p.dataset.tag));
  }
  tagInput.addEventListener("tag-added", (e) => addTagPill(e.detail));

  /* ---------- inline-edit toggle ---------- */
  const scalarEls = form.querySelectorAll("input[name], textarea[name], select[name]");
  const original  = Object.fromEntries([...scalarEls].map(el => [el.name, el.value]));

  const setDisabled = (state) => {
    scalarEls.forEach(el => (el.disabled = state));
    tagInput.style.display        = state ? "none" : "";
    pillbox.style.pointerEvents   = state ? "none" : "auto";
  };

  editBtn.onclick = () => {
    setDisabled(false);
    editBtn.hidden  = true;
    saveBtn.hidden  = false;
    cancelBtn.hidden= false;
  };

  cancelBtn.onclick = () => {
    scalarEls.forEach(el => { if (el.name in original) el.value = original[el.name]; });
    pillbox.innerHTML = "";
    safeParse(tagHidden.value).forEach(addTagPill);
    setDisabled(true);
    editBtn.hidden  = false;
    saveBtn.hidden  = true;
    cancelBtn.hidden= true;
  };

  /* ---------- SAVE (fixed) ---------- */
  saveBtn.onclick = async () => {
    /* gather current values */
    const payload = {};
    scalarEls.forEach(el => { if (!el.disabled) payload[el.name] = el.value || null; });
    payload.tags = [...pillbox.children].map(p => p.dataset.tag);

    /* PATCH */
    const ok = await fetch(`/api/items/${itemId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    }).then(r => r.ok);
    if (!ok) { alert("Update failed"); return; }

    /* re-fetch fresh record */
    const updated = await fetch(`/api/items/${itemId}`).then(r => r.json());

    /* lock UI & cache */
    Object.assign(original, updated);
    setDisabled(true);
    editBtn.hidden  = false;
    saveBtn.hidden  = true;
    cancelBtn.hidden= true;

    /* update header & pills */
    headerH2.textContent = updated.name;
    pillbox.innerHTML = "";
    (updated.tags || []).forEach(t => addTagPill(t.name));
  };

  /* ---------- DELETE ---------- */
  delBtn.onclick = async () => {
    if (!confirm("Delete this item?")) return;
    const ok = (await fetch(`/api/items/${itemId}`, { method: "DELETE" })).ok;
    if (ok) location.href = "/items";
  };

  /* ---------- gallery ---------- */
  let imgs = [];
  const refreshGallery = async () => {
    const data = await fetch(`/api/items/${itemId}/images`).then(r => r.json());
    imgs = data.map(i => i.url);
    gallery.innerHTML = data.map(i => `
      <li data-id="${i.id}" class="relative cursor-pointer border rounded overflow-hidden">
        <button data-image-id="${i.id}" class="image-delete-btn absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white px-1 py-0.5 rounded text-xs z-10">√ó</button>
        <img src="${i.url}" class="w-full h-48 object-cover" loading="lazy"/>
        ${i.sort_order === 1 ? `<span class="absolute top-2 left-2 bg-yellow-400 text-white px-1 rounded text-sm z-10">‚òÖ Thumbnail</span>` : ""}
      </li>`).join("");
  };
  new Sortable(gallery, {
    animation: 150,
    onEnd: async () => {
      const order = [...gallery.children].map(li => li.dataset.id);
      await fetch(`/api/items/${itemId}/images/reorder`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ new_order: order }),
      });
      refreshGallery();
    },
  });
  gallery.addEventListener("click", async (e) => {
    if (e.target.matches(".image-delete-btn")) {
      if (!confirm("Delete this image?")) return;
      const imgId = e.target.dataset.imageId;
      const ok = (await fetch(`/api/items/${itemId}/images/${imgId}`, { method: "DELETE" })).ok;
      if (ok) { e.target.closest("li").remove(); refreshGallery(); }
      return;
    }
    const imgEl = e.target.closest("li")?.querySelector("img");
    if (imgEl) { await refreshGallery(); showAt(imgs.indexOf(imgEl.src)); lightbox.classList.remove("hidden"); }
  });

  /* upload images */
  uploadBt.onclick = async () => {
    const files = [...uploadIn.files];
    const url   = urlIn.value.trim();
    if (!files.length && !url) return alert("Choose files or enter a URL");

    const fd = new FormData();
    files.forEach(f => fd.append("files", f));
    if (url) fd.append("url", url);
    uploadBt.disabled = true;
    const ok = (await fetch(`/api/items/${itemId}/images`, { method: "POST", body: fd })).ok;
    uploadBt.disabled = false;
    if (ok) { uploadIn.value = ""; urlIn.value = ""; refreshGallery(); }
  };

  /* lightbox + zoom */
  const lightbox = $("lightbox"), lbImg = $("lb-img");
  const lbPrev = $("lb-prev"), lbNext = $("lb-next"), lbClose = $("lb-close");
  const ziBtn = $("lb-zoom-in"), zoBtn = $("lb-zoom-out");
  const zoomLevels = [1, 1.5, 2]; let zoomIdx = 0;
  const resetZoom = () => { zoomIdx = 0; lbImg.style.transform = "scale(1)"; };
  const showAt    = (i) => { i = (i + imgs.length) % imgs.length; lbImg.src = imgs[i]; lightbox.dataset.idx = i; resetZoom(); };
  lbClose.onclick = () => lightbox.classList.add("hidden");
  lbPrev.onclick  = () => showAt(+lightbox.dataset.idx - 1);
  lbNext.onclick  = () => showAt(+lightbox.dataset.idx + 1);
  ziBtn.onclick   = () => { if (zoomIdx < zoomLevels.length - 1) zoomIdx++; lbImg.style.transform = `scale(${zoomLevels[zoomIdx]})`; };
  zoBtn.onclick   = () => { if (zoomIdx > 0) zoomIdx--; lbImg.style.transform = `scale(${zoomLevels[zoomIdx]})`; };

  /* init */
  refreshGallery();
  setDisabled(true);
});
</script>
{% endblock %}