<!-- jewel_db/templates/item_detail.html -->
{% extends "base.html" %}
{% block title %}{{ item.name }} – Jewelry Inventory{% endblock %}

{% block content %}
  <!-- HEADER: Name + Edit/Delete/Back -->
  <div class="mb-6 flex items-center justify-between">
    <h2 class="text-2xl font-semibold">{{ item.name }}</h2>
    <div class="space-x-2">
      <a
        href="/items/{{ item.id }}/edit"
        class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm"
      >
        Edit
      </a>
      <button
        data-id="{{ item.id }}"
        class="delete-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm"
      >
        Delete
      </button>
      <a href="/items" class="text-gray-600 underline text-sm">Back to list</a>
    </div>
  </div>

  <!-- Gallery Grid -->
  <ul id="gallery" class="grid grid-cols-3 gap-4 mb-8">
    {% for img in images %}
    <li data-id="{{ img.id }}"
        class="relative cursor-move border rounded overflow-hidden">
      <!-- per-image delete button -->
      <button
        data-image-id="{{ img.id }}"
        class="image-delete-btn absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white px-1 py-0.5 rounded text-xs z-10"
        title="Delete this image"
      >×</button>

      <img
        src="{{ img.url }}"
        class="w-full h-48 object-cover"
      />

      {% if img.sort_order == 1 %}
      <span
        class="absolute top-2 left-2 bg-yellow-400 text-white px-1 rounded text-sm z-10"
      >★ Thumbnail</span>
      {% endif %}
    </li>
    {% endfor %}
  </ul>

  <!-- Item Details -->
  <div class="space-y-2 text-gray-700">
    <p><strong>ID:</strong> {{ item.id }}</p>
    <p><strong>Material:</strong> {{ item.material or '—' }}</p>
    <p><strong>Gemstone:</strong> {{ item.gemstone or '—' }}</p>
    <p>
      <strong>Weight:</strong>
      {{ "%.2f"|format(item.weight) if item.weight is not none else '—' }} g
    </p>
    <p>
      <strong>Price:</strong>
      {{ "%.2f"|format(item.price) if item.price is not none else '—' }}
    </p>
    <p><strong>Description:</strong> {{ item.description or '—' }}</p>
    <p>
      <strong>Created At:</strong>
      {{ item.created_at.strftime("%Y-%m-%d %H:%M:%S") }}
    </p>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    (function(){
      const gallery = document.getElementById("gallery");

      function readOrder() {
        return Array.from(gallery.children).map(li => li.dataset.id);
      }

      async function refreshGallery() {
        const imgs = await fetch(`/api/items/{{ item.id }}/images`).then(r=>r.json());
        const orderMap = {};
        imgs.forEach(i=> orderMap[i.id] = i.sort_order);
        for(const li of gallery.children){
          const id = li.dataset.id;
          const badge = li.querySelector("span");
          if(orderMap[id]===1){
            if(!badge){
              const s = document.createElement("span");
              s.textContent="★ Thumbnail";
              s.className="absolute top-2 left-2 bg-yellow-400 text-white px-1 rounded text-sm z-10";
              li.appendChild(s);
            }
          } else if(badge){
            badge.remove();
          }
        }
      }

      // 1) drag-and-drop reorder
      new Sortable(gallery, {
        animation: 150,
        onEnd: async () => {
          await fetch(`/api/items/{{ item.id }}/images/reorder`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ new_order: readOrder() }),
          });
          await refreshGallery();
        }
      });

      // 2) click to set thumbnail (ignore clicks on delete buttons here)
      gallery.addEventListener("click", async e => {
        if (e.target.matches(".image-delete-btn")) return;
        const li = e.target.closest("li[data-id]");
        if (!li) return;
        const clickedId = li.dataset.id;
        const rest = readOrder().filter(i=>i!==clickedId);
        await fetch(`/api/items/{{ item.id }}/images/reorder`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ new_order: [clickedId, ...rest] }),
        });
        await refreshGallery();
      });

      // 3) per-image delete
      gallery.addEventListener("click", async e => {
        if (!e.target.matches(".image-delete-btn")) return;
        const imgId = e.target.dataset.imageId;
        if (!confirm("Delete this image?")) return;
        const res = await fetch(`/api/items/{{ item.id }}/images/${imgId}`, {
          method: "DELETE"
        });
        if (res.status === 204) {
          e.target.closest("li[data-id]").remove();
          await refreshGallery();
        } else {
          alert("Failed to delete image");
        }
      });

      // initial badge & detail setup
      refreshGallery();
    })();
  </script>
{% endblock %}
