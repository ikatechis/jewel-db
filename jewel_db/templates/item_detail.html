{% extends "base.html" %}
{% block title %}{{ item.name }} ‚Äì Jewelry Inventory{% endblock %}

{% block content %}

  <!-- HEADER -->
  <div class="mb-6 flex items-center justify-between">
    <h2 class="text-2xl font-semibold">{{ item.name }}</h2>
    <div class="space-x-2">
      <button id="edit-btn"   class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">Edit</button>
      <button id="save-btn"   class="bg-green-600  hover:bg-green-700  text-white px-3 py-1 rounded text-sm" hidden>Save</button>
      <button id="cancel-btn" class="bg-gray-400  hover:bg-gray-500  text-white px-3 py-1 rounded text-sm" hidden>Cancel</button>
      <button id="item-delete-btn" data-id="{{ item.id }}" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">Delete</button>
      <a href="/items" class="text-gray-600 underline text-sm">Back to list</a>
    </div>
  </div>

  <!-- hidden data root for JS -->
  <div id="item-root" data-item-id="{{ item.id }}"></div>

  <!-- GALLERY -->
  <ul id="gallery" class="grid grid-cols-3 gap-4 mb-8">
    {% for img in images %}
    <li data-id="{{ img.id }}" class="relative cursor-pointer border rounded overflow-hidden">
      <button data-image-id="{{ img.id }}"
              class="image-delete-btn absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white px-1 py-0.5 rounded text-xs z-10"
              title="Delete this image">√ó</button>
      <img src="{{ img.url }}" class="w-full h-48 object-cover" loading="lazy"/>
      {% if img.sort_order == 1 %}
      <span class="absolute top-2 left-2 bg-yellow-400 text-white px-1 rounded text-sm z-10">‚òÖ Thumbnail</span>
      {% endif %}
    </li>
    {% endfor %}
  </ul>

  <!-- LIGHTBOX -->
  <div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <button id="lb-close" class="absolute top-4 right-4 text-white text-3xl">&times;</button>
    <button id="lb-prev"  class="absolute left-4 text-white text-4xl select-none">&#10094;</button>

    <div class="relative">
      <img id="lb-img" src="" class="max-h-[80vh] max-w-[80vw] transition-transform"/>
      <!-- ZOOM TOOLBAR -->
      <div class="absolute bottom-2 left-1/2 -translate-x-1/2 bg-black bg-opacity-50 rounded p-2 flex space-x-4">
        <button id="lb-zoom-in"  class="text-white text-xl select-none">Ôºãüîç</button>
        <button id="lb-zoom-out" class="text-white text-xl select-none">Ôºçüîç</button>
      </div>
    </div>

    <button id="lb-next"  class="absolute right-4 text-white text-4xl select-none">&#10095;</button>
  </div>

  <!-- IMAGE UPLOAD -->
  <div class="mb-8">
    <label class="block font-medium mb-2">Upload Images</label>
    <div class="flex items-center space-x-2">
      <input id="upload-input" type="file" multiple accept="image/*" class="border rounded p-1"/>
      <button id="upload-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">Upload</button>
    </div>
  </div>

  <!-- EDIT FORM -->
  <form id="item-detail-form" class="space-y-2 text-gray-700">
    <input type="hidden" name="id" value="{{ item.id }}"/>
    <div><label class="block font-medium">Material</label>
         <input type="text" name="material" value="{{ item.material or '' }}" disabled class="w-full border rounded p-2"/></div>
    <div><label class="block font-medium">Gemstone</label>
         <input type="text" name="gemstone" value="{{ item.gemstone or '' }}" disabled class="w-full border rounded p-2"/></div>
    <div class="grid grid-cols-2 gap-4">
      <div><label class="block font-medium">Weight (g)</label>
           <input type="number" step="0.01" name="weight" value="{{ '%.2f'|format(item.weight) }}" disabled class="w-full border rounded p-2"/></div>
      <div><label class="block font-medium">Price</label>
           <input type="number" step="0.01" name="price"  value="{{ '%.2f'|format(item.price)  }}" disabled class="w-full border rounded p-2"/></div>
    </div>
    <div><label class="block font-medium">Description</label>
         <textarea name="description" rows="3" disabled class="w-full border rounded p-2">{{ item.description or '' }}</textarea></div>
  </form>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  /* ---------- helpers ---------- */
  const itemId   = parseInt(document.getElementById("item-root").dataset.itemId, 10);
  const $        = id => document.getElementById(id);

  const gallery  = $("gallery");
  const form     = $("item-detail-form");
  const editBtn  = $("edit-btn");
  const saveBtn  = $("save-btn");
  const cancelBtn= $("cancel-btn");
  const delBtn   = $("item-delete-btn");
  const uploadIn = $("upload-input");
  const uploadBt = $("upload-btn");

  const lightbox = $("lightbox");
  const lbImg    = $("lb-img");
  const lbPrev   = $("lb-prev");
  const lbNext   = $("lb-next");
  const lbClose  = $("lb-close");
  const ziBtn    = $("lb-zoom-in");
  const zoBtn    = $("lb-zoom-out");

  /* ---------- inline-edit ---------- */
  const original = {};
  form.querySelectorAll("input[name], textarea[name]").forEach(el => original[el.name] = el.value);
  const setDisabled = d => form.querySelectorAll("input[name], textarea[name]").forEach(el => (el.disabled = d));

  editBtn.onclick   = () => { setDisabled(false); editBtn.hidden = true; saveBtn.hidden = cancelBtn.hidden = false; };
  cancelBtn.onclick = () => {
    Object.keys(original).forEach(k => { form.querySelector(`[name="${k}"]`).value = original[k]; });
    setDisabled(true); editBtn.hidden = false; saveBtn.hidden = cancelBtn.hidden = true;
  };
  saveBtn.onclick   = async () => {
    const payload = {};
    form.querySelectorAll("input[name], textarea[name]").forEach(el => { payload[el.name] = el.value || null; });
    const res = await fetch(`/api/items/${itemId}`, {method: "PATCH", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload)});
    if (!res.ok) { alert("Update failed"); return; }
    const updated = await res.json();
    Object.assign(original, updated);
    setDisabled(true); editBtn.hidden = false; saveBtn.hidden = cancelBtn.hidden = true;
  };

  delBtn.onclick = async () => {
    if (!confirm("Delete this item?")) return;
    if ((await fetch(`/api/items/${itemId}`, {method:"DELETE"})).status === 204) location.href = "/items";
  };

  /* ---------- gallery helpers ---------- */
  let imgs = [];
  const refreshGallery = async () => {
    const data = await fetch(`/api/items/${itemId}/images`).then(r=>r.json());
    imgs = data.map(i => i.url);
    // update thumbnail badges
    gallery.querySelectorAll("span[data-badge]").forEach(b => b.remove());
    data.forEach(i => {
      if (i.sort_order === 1) {
        const li = gallery.querySelector(`li[data-id="${i.id}"]`);
        if (li) {
          const badge = document.createElement("span");
          badge.dataset.badge = "thumb";
          badge.className = "absolute top-2 left-2 bg-yellow-400 text-white px-1 rounded text-sm z-10";
          badge.textContent = "‚òÖ Thumbnail";
          li.appendChild(badge);
        }
      }
    });
  };

  /* -------- gallery drag-sort -------- */
  new Sortable(gallery, {
    animation: 150,
    onEnd: async () => {
      const order = Array.from(gallery.children).map(li => li.dataset.id);
      await fetch(`/api/items/${itemId}/images/reorder`, {method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({new_order:order})});
      refreshGallery();
    }
  });

  /* -------- gallery click -------- */
  gallery.addEventListener("click", async e => {
    if (e.target.matches(".image-delete-btn")) {
      if (!confirm("Delete this image?")) return;
      const imgId = e.target.dataset.imageId;
      if ((await fetch(`/api/items/${itemId}/images/${imgId}`, {method:"DELETE"})).status === 204) {
        e.target.closest("li").remove();
        refreshGallery();
      }
      return;
    }
    const img = e.target.closest("li")?.querySelector("img");
    if (img) {
      await refreshGallery();
      let idx = imgs.indexOf(img.src); if (idx < 0) idx = 0;
      lbImg.src = imgs[idx]; lightbox.dataset.idx = idx;
      zoomIdx = 0; lbImg.style.transform = "scale(1)";
      lightbox.classList.remove("hidden");
    }
  });

  /* -------- upload images -------- */
  uploadBt.onclick = async () => {
    const files = Array.from(uploadIn.files); if (!files.length) return alert("Choose files first");
    uploadBt.disabled = true;
    const fd = new FormData(); files.forEach(f => fd.append("files", f));
    const ok = (await fetch(`/api/items/${itemId}/images`, {method:"POST", body: fd})).ok;
    if (!ok) alert("Upload failed"); else { uploadIn.value = ""; refreshGallery(); }
    uploadBt.disabled = false;
  };

  /* -------- lightbox nav & zoom -------- */
  const zoomLevels = [1,1.5,2]; let zoomIdx = 0;
  const resetZoom  = () => { zoomIdx = 0; lbImg.style.transform = "scale(1)"; };

  const showAt = i => {
    if (!imgs.length) return;
    i = (i + imgs.length) % imgs.length;
    lbImg.src = imgs[i]; lightbox.dataset.idx = i; resetZoom();
  };

  lbClose.onclick = () => lightbox.classList.add("hidden");
  lbPrev.onclick  = () => showAt(parseInt(lightbox.dataset.idx,10) - 1);
  lbNext.onclick  = () => showAt(parseInt(lightbox.dataset.idx,10) + 1);
  ziBtn.onclick   = () => { if (zoomIdx < zoomLevels.length - 1) zoomIdx++; lbImg.style.transform = `scale(${zoomLevels[zoomIdx]})`; };
  zoBtn.onclick   = () => { if (zoomIdx > 0) zoomIdx--;                   lbImg.style.transform = `scale(${zoomLevels[zoomIdx]})`; };

  /* -------- initialise -------- */
  refreshGallery();
  setDisabled(true);
});
</script>
{% endblock %}
